"""
è¾“å‡ºç”Ÿæˆæ¨¡å— - è´Ÿè´£ç”Ÿæˆè®²è§£æ–‡æ¡£
"""
import json
from pathlib import Path
from typing import List, Dict, Tuple
from datetime import datetime

class OutputGenerator:
    """è¾“å‡ºç”Ÿæˆå™¨"""
    
    def __init__(self, output_dir: str, pdf_name: str):
        """
        åˆå§‹åŒ–è¾“å‡ºç”Ÿæˆå™¨
        
        Args:
            output_dir: è¾“å‡ºç›®å½•
            pdf_name: PDFæ–‡ä»¶å
        """
        self.output_dir = Path(output_dir)
        self.pdf_name = pdf_name
        self.output_dir.mkdir(parents=True, exist_ok=True)
        
    def generate_markdown(self, analyses: List[Tuple[int, str, str]]) -> str:
        """
        ç”ŸæˆMarkdownæ ¼å¼çš„è®²è§£æ–‡æ¡£
        
        Args:
            analyses: List of (page_num, image_path, analysis_text) tuples
            
        Returns:
            ç”Ÿæˆçš„Markdownæ–‡ä»¶è·¯å¾„
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # æ„å»ºMarkdownå†…å®¹
        md_content = f"""# è¯¾ä»¶è®²è§£: {self.pdf_name}

> ç”Ÿæˆæ—¶é—´: {timestamp}
> æ€»é¡µæ•°: {len(analyses)}

---

"""
        
        for page_num, image_path, analysis in analyses:
            # ç›¸å¯¹è·¯å¾„(ç”¨äºMarkdowné“¾æ¥)
            rel_image_path = Path(image_path).relative_to(self.output_dir)
            
            md_content += f"""## ç¬¬ {page_num} é¡µ

![ç¬¬{page_num}é¡µ]({rel_image_path.as_posix()})

{analysis}

---

"""
        
        # æ·»åŠ é¡µè„š
        md_content += f"""
## æ–‡æ¡£è¯´æ˜

- æœ¬æ–‡æ¡£ç”±PDFè¯¾ä»¶è‡ªåŠ¨è®²è§£ç³»ç»Ÿç”Ÿæˆ
- æ¯é¡µå†…å®¹åŒ…å«è¯¾ä»¶æˆªå›¾å’ŒAIè¯¦ç»†è®²è§£
- å»ºè®®ç»“åˆåŸå§‹è¯¾ä»¶ä¸€èµ·å­¦ä¹ 

---
*Generated by PDF Lecture Analyzer*
"""
        
        # ä¿å­˜Markdownæ–‡ä»¶
        output_file = self.output_dir / f"{Path(self.pdf_name).stem}_explained.md"
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(md_content)
            
        return str(output_file)
    
    def generate_html(self, analyses: List[Tuple[int, str, str]]) -> str:
        """
        ç”ŸæˆHTMLæ ¼å¼çš„è®²è§£æ–‡æ¡£
        
        Args:
            analyses: List of (page_num, image_path, analysis_text) tuples
            
        Returns:
            ç”Ÿæˆçš„HTMLæ–‡ä»¶è·¯å¾„
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # HTMLæ¨¡æ¿
        html_content = f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ä»¶è®²è§£: {self.pdf_name}</title>
    <style>
        body {{
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.8;
        }}
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }}
        .header h1 {{
            margin: 0 0 10px 0;
            font-size: 2em;
        }}
        .header .meta {{
            opacity: 0.9;
            font-size: 0.9em;
        }}
        .page-section {{
            background: white;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }}
        .page-header {{
            background: #4a5568;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: bold;
        }}
        .page-content {{
            padding: 20px;
        }}
        .page-image {{
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            margin-bottom: 20px;
        }}
        .analysis {{
            font-size: 1em;
            color: #2d3748;
            white-space: pre-wrap;
        }}
        .footer {{
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 0.9em;
        }}
        h2, h3, h4 {{
            color: #2d3748;
            margin-top: 1.5em;
        }}
        strong {{
            color: #667eea;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š {self.pdf_name}</h1>
        <div class="meta">
            ç”Ÿæˆæ—¶é—´: {timestamp} | æ€»é¡µæ•°: {len(analyses)}
        </div>
    </div>
"""
        
        # æ·»åŠ æ¯é¡µå†…å®¹
        for page_num, image_path, analysis in analyses:
            rel_image_path = Path(image_path).relative_to(self.output_dir)
            
            # å°†Markdownæ ¼å¼çš„åˆ†ææ–‡æœ¬è½¬æ¢ä¸ºHTML(ç®€å•å¤„ç†)
            html_analysis = self._markdown_to_html(analysis)
            
            html_content += f"""
    <div class="page-section">
        <div class="page-header">ç¬¬ {page_num} é¡µ</div>
        <div class="page-content">
            <img src="{rel_image_path.as_posix()}" alt="ç¬¬{page_num}é¡µ" class="page-image">
            <div class="analysis">{html_analysis}</div>
        </div>
    </div>
"""
        
        html_content += """
    <div class="footer">
        <p>æœ¬æ–‡æ¡£ç”± <strong>PDFè¯¾ä»¶è‡ªåŠ¨è®²è§£ç³»ç»Ÿ</strong> ç”Ÿæˆ</p>
        <p>å»ºè®®ç»“åˆåŸå§‹è¯¾ä»¶ä¸€èµ·å­¦ä¹ </p>
    </div>
</body>
</html>
"""
        
        # ä¿å­˜HTMLæ–‡ä»¶
        output_file = self.output_dir / f"{Path(self.pdf_name).stem}_explained.html"
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        return str(output_file)
    
    def save_cache(self, analyses: List[Tuple[int, str, str]], cache_dir: str):
        """
        ä¿å­˜åˆ†æç»“æœåˆ°ç¼“å­˜
        
        Args:
            analyses: List of (page_num, image_path, analysis_text) tuples
            cache_dir: ç¼“å­˜ç›®å½•
        """
        cache_path = Path(cache_dir)
        cache_path.mkdir(parents=True, exist_ok=True)
        
        cache_data = {
            'pdf_name': self.pdf_name,
            'timestamp': datetime.now().isoformat(),
            'analyses': [
                {
                    'page_num': page_num,
                    'image_path': image_path,
                    'analysis': analysis
                }
                for page_num, image_path, analysis in analyses
            ]
        }
        
        cache_file = cache_path / f"{Path(self.pdf_name).stem}_cache.json"
        with open(cache_file, 'w', encoding='utf-8') as f:
            json.dump(cache_data, f, ensure_ascii=False, indent=2)
    
    def load_cache(self, cache_dir: str) -> List[Tuple[int, str, str]]:
        """
        ä»ç¼“å­˜åŠ è½½åˆ†æç»“æœ
        
        Args:
            cache_dir: ç¼“å­˜ç›®å½•
            
        Returns:
            List of (page_num, image_path, analysis_text) tuples or None
        """
        cache_path = Path(cache_dir)
        cache_file = cache_path / f"{Path(self.pdf_name).stem}_cache.json"
        
        if not cache_file.exists():
            return None
            
        try:
            with open(cache_file, 'r', encoding='utf-8') as f:
                cache_data = json.load(f)
                
            return [
                (item['page_num'], item['image_path'], item['analysis'])
                for item in cache_data['analyses']
            ]
        except Exception:
            return None
    
    def _markdown_to_html(self, markdown_text: str) -> str:
        """ç®€å•çš„Markdownåˆ°HTMLè½¬æ¢"""
        html = markdown_text
        
        # ç²—ä½“
        import re
        html = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', html)
        
        # æ ‡é¢˜
        html = re.sub(r'^### (.+)$', r'<h4>\1</h4>', html, flags=re.MULTILINE)
        html = re.sub(r'^## (.+)$', r'<h3>\1</h3>', html, flags=re.MULTILINE)
        html = re.sub(r'^# (.+)$', r'<h2>\1</h2>', html, flags=re.MULTILINE)
        
        # æ¢è¡Œ
        html = html.replace('\n\n', '</p><p>')
        html = f'<p>{html}</p>'
        
        return html
